<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Admin Settings')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container">
    <div th:replace="~{fragments/messages :: messages}"></div>

    <div class="card">
        <h2>Configuración de usuarios</h2>
        <p class="text-muted">
            Administra los PIN y perfiles disponibles en Casero Web.
        </p>
    </div>

    <div class="card">
        <h3>Crear nuevo usuario</h3>
        <form th:action="@{/admin/users/create}"
              th:object="${createUserForm}"
              method="post"
              class="form-grid">
            <label>
                Nombre
                <input type="text" th:field="*{name}" placeholder="Ej: Ana Pérez" required>
                <span class="form-error" th:if="${#fields.hasErrors('name')}"
                      th:errors="*{name}">Error</span>
            </label>
            <label>
                Rol
                <select th:field="*{role}">
                    <option th:each="role : ${roles}"
                            th:value="${role}"
                            th:text="${role.name()}"></option>
                </select>
                <span class="form-error" th:if="${#fields.hasErrors('role')}"
                      th:errors="*{role}">Error</span>
            </label>
            <label>
                PIN
                <input type="password"
                       th:field="*{pin}"
                       pattern="[0-9]{4}"
                       minlength="4"
                       maxlength="4"
                       inputmode="numeric"
                       placeholder="••••"
                       required>
                <span class="form-error" th:if="${#fields.hasErrors('pin')}"
                      th:errors="*{pin}">Error</span>
            </label>
            <div class="form-actions">
                <button type="submit">Guardar</button>
            </div>
        </form>
    </div>

    <div class="card">
        <h3>Usuarios existentes</h3>
        <div class="admin-users-grid">
            <div class="admin-user-card" th:each="user : ${users}">
                <div class="admin-user-card__header">
                    <h4 th:text="${user.name}">Nombre</h4>
                    <span class="badge" th:text="${user.role.name()}">ROL</span>
                </div>
                <p class="text-muted" th:text="${'Creado: ' + #temporals.format(user.createdAt, 'dd-MM-yyyy HH:mm')}">
                    Creado
                </p>
                <form th:action="@{/admin/users/pin}"
                      method="post"
                      class="admin-pin-form">
                    <input type="hidden" name="userId" th:value="${user.id}">
                    <label>
                        Nuevo PIN
                        <input type="password"
                               name="pin"
                               pattern="[0-9]{4}"
                               minlength="4"
                               maxlength="4"
                               inputmode="numeric"
                               placeholder="••••"
                               required>
                    </label>
                    <div class="form-error"
                         th:if="${pinErrorUserId != null and pinErrorUserId == user.id}"
                         th:text="${pinError}">Error</div>
                    <div class="form-actions">
                        <button type="submit">Actualizar PIN</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>
