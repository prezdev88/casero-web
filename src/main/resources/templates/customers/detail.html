<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Cliente')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container">
    <div th:replace="~{fragments/messages :: messages}"></div>

    <div class="card">
        <div class="customer-header">
            <div class="customer-header__title">
                <h2 th:text="${customer.name}">Cliente</h2>
                <a class="icon-button" title="Editar nombre"
                   th:href="@{'/customers/' + ${customer.id} + '/actions/name/edit'}">‚úèÔ∏è</a>
            </div>
            <button type="button"
                    class="customer-score-badge customer-score-badge--button"
                    th:classappend="${customerScore != null ? ' score-chip--' + T(cl.casero.migration.util.CustomerScoreColor).bucket(customerScore) : ''}"
                    data-score-toggle="customer-score-explanation"
                    aria-expanded="false"
                    title="Ver detalle de la nota">
                <span class="customer-score-badge__value"
                      th:classappend="${customerScore != null ? ' score-value--' + T(cl.casero.migration.util.CustomerScoreColor).bucket(customerScore) : ''}"
                      th:text="${customerScore != null ? #numbers.formatDecimal(customerScore, 1, 'DEFAULT', 2, 'DEFAULT') : '--'}">7.00</span>
            </button>
        </div>
        <p class="highlight-debt text-red"
           th:text="${T(cl.casero.migration.util.CurrencyUtil).format(customer.debt)}">$0</p>
        <p class="customer-score-explanation"
           id="customer-score-explanation"
           th:if="${customerScoreExplanation}"
           th:text="${customerScoreExplanation}"
           hidden>
            Explicaci√≥n del comportamiento de pago del cliente.
        </p>
        <p class="text-muted">
            <span th:text="${customer.address}">Direcci√≥n</span>
            <a class="icon-button" title="Editar direcci√≥n"
               th:href="@{'/customers/' + ${customer.id} + '/actions/address/edit'}">‚úèÔ∏è</a>
        </p>
        <p class="text-muted sector-row">
            <span class="sector-row__value" th:text="${customer.sector.name}">Sector</span>
            <a class="icon-button" title="Cambiar sector"
               th:href="@{'/customers/' + ${customer.id} + '/actions/sector/edit'}">‚úèÔ∏è</a>
        </p>
        <div class="transactions-json"
             th:if="${currentUser != null and currentUser.admin}"
             th:data-json-url="@{'/admin/customers/' + ${customer.id} + '/transactions/json'}">
            <button type="button"
                    id="transactions-json-toggle"
                    class="text-button">
                Ver transacciones en JSON
            </button>
            <div class="transactions-json__panel" id="transactions-json-panel" hidden>
                <div class="transactions-json__toolbar">
                    <span>Transacciones en JSON</span>
                    <div class="transactions-json__actions">
                        <button type="button" class="text-button"
                                id="transactions-json-copy">Copiar</button>
                        <button type="button" class="text-button"
                                id="transactions-json-close">Cerrar</button>
                    </div>
                </div>
                <pre id="transactions-json-content">Cargando...</pre>
            </div>
        </div>
    </div>
    <div class="card customer-actions-card">
        <div class="customer-actions__grid customer-actions__grid--inline">
            <a class="customer-actions__action customer-actions__action--payment"
               th:href="@{'/customers/' + ${customer.id} + '/actions/payment'}"
               data-testid="customer-action-payment">
                <span class="customer-actions__icon">üí∏</span>
                <span class="customer-actions__action-text">
                    <span class="customer-actions__action-title">Abonar</span>
                    <span class="customer-actions__action-desc">Registrar un pago</span>
                </span>
            </a>
            <a class="customer-actions__action customer-actions__action--sale"
               th:href="@{'/customers/' + ${customer.id} + '/actions/sale'}"
               data-testid="customer-action-sale">
                <span class="customer-actions__icon">üßæ</span>
                <span class="customer-actions__action-text">
                    <span class="customer-actions__action-title">Mantenci√≥n</span>
                    <span class="customer-actions__action-desc">Registrar venta o mantenci√≥n</span>
                </span>
            </a>
            <a class="customer-actions__action customer-actions__action--refund"
               th:href="@{'/customers/' + ${customer.id} + '/actions/refund'}">
                <span class="customer-actions__icon">‚Ü©Ô∏è</span>
                <span class="customer-actions__action-text">
                    <span class="customer-actions__action-title">Devoluci√≥n</span>
                    <span class="customer-actions__action-desc">Registrar un reembolso</span>
                </span>
            </a>
            <a class="customer-actions__action customer-actions__action--fault-discount"
               th:href="@{'/customers/' + ${customer.id} + '/actions/fault-discount'}">
                <span class="customer-actions__icon">üõ†Ô∏è</span>
                <span class="customer-actions__action-text">
                    <span class="customer-actions__action-title">Descuento por falla</span>
                    <span class="customer-actions__action-desc">Aplicar rebaja por da√±o o falla</span>
                </span>
            </a>
            <a class="customer-actions__action customer-actions__action--forgiveness"
               th:href="@{'/customers/' + ${customer.id} + '/actions/forgiveness'}">
                <span class="customer-actions__icon">‚ù§Ô∏è</span>
                <span class="customer-actions__action-text">
                    <span class="customer-actions__action-title">Condonar deuda</span>
                    <span class="customer-actions__action-desc">Dejar saldo en cero</span>
                </span>
            </a>
            <button type="button"
                    class="customer-actions__action customer-actions__action--toggle customer-actions__action--cycles"
                    data-score-toggle="customer-score-cycles"
                    aria-expanded="false">
                <span class="customer-actions__icon">üìä</span>
                <span class="customer-actions__action-text customer-actions__action-text--grow">
                    <span class="customer-actions__action-title">Historial de ciclos</span>
                    <span class="customer-actions__action-desc"
                          th:text="${#lists.isEmpty(customerScoreCycles) ? 'Sin ciclos' : #lists.size(customerScoreCycles) + (#lists.size(customerScoreCycles) == 1 ? ' ciclo' : ' ciclos')}">
                        Sin ciclos
                    </span>
                </span>
                <span class="score-cycles-toggle__icon" aria-hidden="true">‚åÑ</span>
            </button>
            <button type="button"
                    class="customer-actions__action customer-actions__action--toggle customer-actions__action--report"
                    data-score-toggle="customer-report-panel"
                    aria-expanded="false">
                <span class="customer-actions__icon">üìÑ</span>
                <span class="customer-actions__action-text customer-actions__action-text--grow">
                    <span class="customer-actions__action-title">Cartola en PDF</span>
                    <span class="customer-actions__action-desc">Descargar movimientos</span>
                </span>
                <span class="score-cycles-toggle__icon" aria-hidden="true">‚åÑ</span>
            </button>
        </div>
        <div class="score-cycles-panel"
             id="customer-score-cycles"
             hidden>
            <p class="score-cycles-empty"
               th:if="${#lists.isEmpty(customerScoreCycles)}">
                A√∫n no registra ciclos de compra.
            </p>
            <div class="score-cycle-list" th:if="${!#lists.isEmpty(customerScoreCycles)}">
                <div class="score-cycle"
                     th:each="cycle : ${customerScoreCycles}">
                    <div class="score-cycle__header">
                        <div>
                            <span class="score-cycle__title"
                                  th:text="${'Ciclo ' + cycle.cycleNumber()}">Ciclo 1</span>
                            <span class="score-cycle__range"
                                  th:text="${
                                      cycle.cycleStartDate() != null or cycle.cycleEndDate() != null ?
                                      (cycle.cycleStartDate() != null ? #temporals.format(cycle.cycleStartDate(), 'MMM yyyy') : 'Sin inicio')
                                      + ' - ' +
                                      (cycle.cycleEndDate() != null ? #temporals.format(cycle.cycleEndDate(), 'MMM yyyy') : 'vigente')
                                      : 'Sin fechas registradas'
                                  }">
                                Ene 2024 - Mar 2024
                            </span>
                        </div>
                        <span class="customer-score-chip"
                              th:classappend="${' score-chip--' + T(cl.casero.migration.util.CustomerScoreColor).bucket(cycle.result().score())}">
                            <strong th:text="${#numbers.formatDecimal(cycle.result().score(), 1, 'DEFAULT', 2, 'DEFAULT')}">7.00</strong>
                        </span>
                    </div>
                    <p class="score-cycle__meta">
                        <span th:if="${cycle.result().hasPayments()}">
                            <span th:if="${cycle.result().paymentMonths() != null and cycle.result().cycleMonths() != null and cycle.result().cycleMonths() > 0}"
                                  th:text="${'Pag√≥ en ' + cycle.result().paymentMonths() + ' de ' + cycle.result().cycleMonths() + ' meses'}">
                                Pag√≥ en 3 de 4 meses
                            </span>
                            <span th:unless="${cycle.result().paymentMonths() != null and cycle.result().cycleMonths() != null and cycle.result().cycleMonths() > 0}">
                                Historial de pagos parcial
                            </span>
                        </span>
                        <span th:unless="${cycle.result().hasPayments()}">Sin pagos registrados</span>
                        <span>¬∑</span>
                        <span th:text="${cycle.result().hasOutstandingDebt() ? 'Saldo pendiente' : 'Ciclo cerrado'}">
                            Saldo pendiente
                        </span>
                    </p>
                    <p class="score-cycle__meta" th:if="${cycle.result().daysSinceLastPayment() != null}">
                        √öltimo pago hace
                        <span th:text="${cycle.result().daysSinceLastPayment()}">15</span>
                        <span th:text="${cycle.result().daysSinceLastPayment() == 1 ? 'd√≠a' : 'd√≠as'}">d√≠as</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="customer-report-panel"
             id="customer-report-panel"
             hidden>
            <p class="customer-report-panel__hint">
                Genera un informe para enviar al cliente con los movimientos seleccionados.
            </p>
            <form class="customer-report-form"
                  method="get"
                  th:action="@{'/customers/' + ${customer.id} + '/reports/transactions'}"
                  target="_blank">
                <div class="customer-report-range">
                    <span class="customer-report-range__title">Movimientos a incluir</span>
                    <div class="customer-report-range__options">
                        <label class="customer-report-option">
                            <input type="radio" name="range" value="ALL" checked>
                            <span>Todos los movimientos</span>
                        </label>
                        <label class="customer-report-option customer-report-option--months">
                            <input type="radio" name="range" value="MONTHS">
                            <span>√öltimos</span>
                            <input type="number" name="months" min="1" max="60" value="12" inputmode="numeric" aria-label="Cantidad de meses">
                            <span>meses</span>
                        </label>
                    </div>
                </div>
                <label>
                    <span>Tipo de movimiento</span>
                    <select name="type">
                        <option th:each="entry : ${transactionReportTypeOptions.entrySet()}"
                                th:value="${entry.key}"
                                th:text="${entry.value}"
                                th:selected="${entry.key == 'ALL'}">
                            Todos los tipos
                        </option>
                    </select>
                </label>
                <button type="submit">Ver PDF</button>
            </form>
        </div>
    </div>
    <div class="card">
        <div class="transactions-header">
            <h3>Transacciones</h3>
            <button type="button" id="transactions-sort" class="text-button text-button--order"
                    title="Cambiar orden de las transacciones">
                <span id="transactions-sort-icon" class="text-button__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                        <path d="M7 4h2v11h3l-4 5-4-5h3zm10 15h-3l4-5 4 5h-3V8h-2z"/>
                    </svg>
                </span>
                <span id="transactions-sort-label" class="sr-only"
                      th:text="${ascending} ? 'Orden: Ascendente' : 'Orden: Descendente'">Orden</span>
            </button>
        </div>
        <div id="transactions-list" class="transaction-list" data-testid="transactions-list"></div>
        <p id="transactions-empty" class="card-list__empty">Cargando transacciones...</p>
        <nav class="pagination" id="transactions-pagination" hidden>
            <button type="button" id="transactions-prev">Anterior</button>
            <span id="transactions-page-indicator" class="current">1 / 1</span>
            <button type="button" id="transactions-next">Siguiente</button>
        </nav>
    </div>

</div>
</body>
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', () => {
    const scoreToggles = document.querySelectorAll('[data-score-toggle]');
    scoreToggles.forEach((toggle) => {
        const targetId = toggle.getAttribute('data-score-toggle');
        const target = document.getElementById(targetId);
        toggle.addEventListener('click', () => {
            if (!target) {
                return;
            }
            const isHidden = target.hasAttribute('hidden');
            if (isHidden) {
                target.removeAttribute('hidden');
                toggle.setAttribute('aria-expanded', 'true');
            } else {
                target.setAttribute('hidden', '');
                toggle.setAttribute('aria-expanded', 'false');
            }
        });
    });

    const reportForm = document.querySelector('.customer-report-form');
    if (reportForm) {
        const rangeRadios = reportForm.querySelectorAll('input[name="range"]');
        const monthsInput = reportForm.querySelector('input[name="months"]');
        const updateMonthsState = () => {
            if (!monthsInput) {
                return;
            }
            const selected = reportForm.querySelector('input[name="range"]:checked');
            const shouldEnable = selected && selected.value === 'MONTHS';
            monthsInput.disabled = !shouldEnable;
        };
        rangeRadios.forEach((radio) => {
            radio.addEventListener('change', updateMonthsState);
        });
        updateMonthsState();
    }

    const customerId = /*[[${customer.id}]]*/ 0;
    let ascending = /*[[${ascending}]]*/ false;
    const pageSize = /*[[${transactionsPage.size}]]*/ 10;
    const customersBaseUrl = /*[[@{/customers}]]*/ '/customers';

    const list = document.getElementById('transactions-list');
    const emptyMessage = document.getElementById('transactions-empty');
    const pagination = document.getElementById('transactions-pagination');
    const prevBtn = document.getElementById('transactions-prev');
    const nextBtn = document.getElementById('transactions-next');
    const pageIndicator = document.getElementById('transactions-page-indicator');
    const sortButton = document.getElementById('transactions-sort');
    const sortLabel = document.getElementById('transactions-sort-label');
    const sortIcon = document.getElementById('transactions-sort-icon');
    const iconMap = {
        sale: 'üõí',
        payment: 'üí∞',
        refund: '‚Ü©Ô∏è',
        debt_forgiveness: '‚ù§Ô∏è',
        initial_balance: '‚öñÔ∏è',
        fault_discount: 'üõ†Ô∏è'
    };
    const labelMap = {
        sale: 'Venta',
        payment: 'Abono',
        refund: 'Devoluci√≥n',
        debt_forgiveness: 'Condonaci√≥n de deuda',
        initial_balance: 'Saldo inicial',
        fault_discount: 'Descuento por falla'
    };

    const jsonWrapper = document.querySelector('.transactions-json');
    const jsonToggleBtn = document.getElementById('transactions-json-toggle');
    const jsonPanel = document.getElementById('transactions-json-panel');
    const jsonCopyBtn = document.getElementById('transactions-json-copy');
    const jsonCloseBtn = document.getElementById('transactions-json-close');
    const jsonContent = document.getElementById('transactions-json-content');
    const transactionsJsonUrl = jsonWrapper ? jsonWrapper.dataset.jsonUrl : '';
    let jsonLoaded = false;
    let jsonLoading = false;

    const fetchTransactionsJson = () => {
        if (!transactionsJsonUrl || jsonLoading) {
            return;
        }
        jsonLoading = true;
        jsonContent.textContent = 'Cargando...';
        fetch(transactionsJsonUrl, {headers: {'Accept': 'application/json'}})
            .then((response) => response.ok ? response.json() : Promise.reject())
            .then((data) => {
                jsonContent.textContent = JSON.stringify(data, null, 2);
                jsonLoaded = true;
            })
            .catch(() => {
                jsonContent.textContent = 'No se pudo obtener la informaci√≥n.';
            })
            .finally(() => {
                jsonLoading = false;
            });
    };

    if (jsonToggleBtn && jsonPanel) {
        jsonToggleBtn.addEventListener('click', () => {
            const isHidden = jsonPanel.hasAttribute('hidden');
            if (isHidden) {
                jsonPanel.removeAttribute('hidden');
                if (!jsonLoaded) {
                    fetchTransactionsJson();
                }
            } else {
                jsonPanel.setAttribute('hidden', '');
            }
        });
    }

    if (jsonCloseBtn && jsonPanel) {
        jsonCloseBtn.addEventListener('click', () => {
            jsonPanel.setAttribute('hidden', '');
        });
    }

    if (jsonCopyBtn && jsonContent) {
        jsonCopyBtn.addEventListener('click', () => {
            const payload = jsonContent.textContent || '';
            if (!payload.trim()) {
                return;
            }
            const copy = (text) => navigator.clipboard
                ? navigator.clipboard.writeText(text)
                : new Promise((resolve, reject) => {
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        resolve();
                    } catch (err) {
                        reject(err);
                    }
                });

            copy(payload)
                .then(() => {
                    const original = jsonCopyBtn.textContent;
                    jsonCopyBtn.textContent = 'Copiado';
                    setTimeout(() => {
                        jsonCopyBtn.textContent = original;
                    }, 1500);
                })
                .catch(() => {
                    jsonCopyBtn.textContent = 'Error';
                    setTimeout(() => {
                        jsonCopyBtn.textContent = 'Copiar';
                    }, 1500);
                });
        });
    }

    let currentPage = 0;
    let totalPages = 0;
    let currentQueryController = null;

    const clearList = () => {
        list.innerHTML = '';
    };

    const showEmpty = (message) => {
        emptyMessage.textContent = message;
        emptyMessage.hidden = false;
    };

    const hideEmpty = () => {
        emptyMessage.hidden = true;
    };

    const updatePagination = (page, total, hasPrevious, hasNext) => {
        pageIndicator.textContent = `${total === 0 ? 0 : page + 1} / ${total}`;
        prevBtn.disabled = !hasPrevious || total <= 1;
        nextBtn.disabled = !hasNext || total <= 1;
        pagination.hidden = total <= 1;
    };

    const createTransactionCard = (transaction) => {
        const card = document.createElement('div');
        card.className = `transaction-card transaction-card--${transaction.typeKey.toLowerCase()}`;
        card.setAttribute('data-testid', 'transaction-card');

        const topRow = document.createElement('div');
        topRow.className = 'transaction-card__row';

        const date = document.createElement('span');
        date.className = 'transaction-card__date';
        date.textContent = transaction.formattedDate;
        topRow.appendChild(date);

        const type = document.createElement('span');
        type.className = 'transaction-card__type';
        const typeIcon = document.createElement('span');
        const iconKey = transaction.typeKey ? transaction.typeKey.toLowerCase() : '';
        typeIcon.textContent = iconMap[iconKey] || 'üìÑ';
        typeIcon.classList.add('transaction-card__type-icon');
        type.appendChild(typeIcon);
        const typeText = document.createElement('span');
        const typeLabel = labelMap[iconKey] || transaction.typeKey;
        typeText.textContent = ` ${typeLabel}`;
        type.appendChild(typeText);
        topRow.appendChild(type);

        card.appendChild(topRow);

        const detail = document.createElement('p');
        detail.className = 'transaction-card__detail';
        detail.textContent = transaction.detail;
        card.appendChild(detail);

        const amount = document.createElement('p');
        amount.className = 'transaction-card__amount';
        amount.textContent = transaction.formattedAmount;
        card.appendChild(amount);

        const balance = document.createElement('p');
        balance.className = 'transaction-card__balance';
        balance.textContent = `Saldo: ${transaction.formattedBalance}`;
        card.appendChild(balance);

        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'transaction-card__delete';
        deleteButton.innerHTML = `
            <svg aria-hidden="true" focusable="false" viewBox="0 0 448 512">
                <path d="M160 0h128c17.7 0 32 14.3 32 32v32h96c8.8 0 16 7.2 16 16s-7.2 16-16 16h-16.1l-26.9 403.5c-1.6 24.4-21.9 44.5-46.4 44.5H105.4c-24.5 0-44.8-20.1-46.4-44.5L32.1 96H16C7.2 96 0 88.8 0 80s7.2-16 16-16h96V32C112 14.3 126.3 0 144 0h16zm128 64V32H160V64h128zm48.1 32H111.9l24.7 378.7c.6 9.5 8.5 17.3 18 17.3h142.7c9.5 0 17.4-7.8 18-17.3L336.1 96z"/>
            </svg>
        `;
        deleteButton.title = 'Eliminar transacci√≥n';
        deleteButton.addEventListener('click', () => {
            if (!confirm('¬øSeguro que deseas eliminar esta transacci√≥n?')) {
                return;
            }
            const form = document.createElement('form');
            form.method = 'post';
            form.action = `${customersBaseUrl}/transactions/${transaction.id}/delete`;
            const customerField = document.createElement('input');
            customerField.type = 'hidden';
            customerField.name = 'customerId';
            customerField.value = customerId;
            form.appendChild(customerField);
            document.body.appendChild(form);
            form.submit();
        });
        card.appendChild(deleteButton);

        return card;
    };

    const applyResponse = (response) => {
        currentPage = response.page;
        totalPages = response.totalPages;
        clearList();

        if (!response.content.length) {
            showEmpty('Sin transacciones');
        } else {
            hideEmpty();
            response.content.forEach((transaction) => {
                list.appendChild(createTransactionCard(transaction));
            });
        }
        updatePagination(response.page, response.totalPages, response.hasPrevious, response.hasNext);
    };

    const updateSortIndicator = () => {
        sortLabel.textContent = ascending ? 'Orden: Ascendente' : 'Orden: Descendente';
        sortIcon.classList.toggle('is-ascending', ascending);
    };

    const fetchTransactions = (pageToLoad = 0) => {
        if (currentQueryController) {
            currentQueryController.abort();
        }
        currentQueryController = new AbortController();
        fetch(`${customersBaseUrl}/${customerId}/transactions?page=${pageToLoad}&size=${pageSize}&ascending=${ascending}`, {
            headers: {'Accept': 'application/json'},
            signal: currentQueryController.signal
        })
            .then((response) => response.ok ? response.json() : Promise.reject())
            .then(applyResponse)
            .catch((error) => {
                if (error.name !== 'AbortError') {
                    showEmpty('Error al cargar transacciones');
                    pagination.hidden = true;
                }
            });
    };

    prevBtn.addEventListener('click', () => {
        if (prevBtn.disabled) {
            return;
        }
        fetchTransactions(Math.max(currentPage - 1, 0));
    });

    nextBtn.addEventListener('click', () => {
        if (nextBtn.disabled) {
            return;
        }
        fetchTransactions(currentPage + 1);
    });

    sortButton.addEventListener('click', () => {
        ascending = !ascending;
        updateSortIndicator();
        fetchTransactions(0);
    });

    updateSortIndicator();

    fetchTransactions(/*[[${transactionsPage.number}]]*/ 0);
});
/*]]>*/
</script>
</html>
