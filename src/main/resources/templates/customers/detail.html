<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Cliente')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container">
    <div th:replace="~{fragments/messages :: messages}"></div>

    <div class="card">
        <div class="customer-header">
            <h2 th:text="${customer.name}">Cliente</h2>
            <a class="icon-button" title="Editar nombre"
               th:href="@{'/customers/' + ${customer.id} + '/actions/name/edit'}">锔</a>
        </div>
        <p class="highlight-debt"
           th:text="${T(cl.casero.migration.util.CurrencyUtil).format(customer.debt)}"
           th:classappend="${customer.debt > 0} ? ' text-red' : ' text-blue'">$0</p>
        <p class="text-muted">
            <span th:text="${customer.address}">Direcci贸n</span>
            <a class="icon-button" title="Editar direcci贸n"
               th:href="@{'/customers/' + ${customer.id} + '/actions/address/edit'}">锔</a>
        </p>
        <p class="text-muted" th:text="${customer.sector.name}">Sector</p>
    </div>

    <div class="card">
        <h3>Men煤 de acciones</h3>
        <ul class="action-menu">
            <li><a th:href="@{'/customers/' + ${customer.id} + '/actions/payment'}">Abonar</a></li>
            <li><a th:href="@{'/customers/' + ${customer.id} + '/actions/sale'}">Mantenci贸n</a></li>
            <li><a th:href="@{'/customers/' + ${customer.id} + '/actions/refund'}">Devoluci贸n</a></li>
            <li><a th:href="@{'/customers/' + ${customer.id} + '/actions/forgiveness'}">CONDONAR DEUDA</a></li>
        </ul>
    </div>

    <div class="card">
        <div class="transactions-header">
            <h3>Transacciones</h3>
            <button type="button" id="transactions-sort" class="text-button">
                <span id="transactions-sort-label"
                      th:text="${ascending} ? 'Orden: Ascendente' : 'Orden: Descendente'">Orden</span>
            </button>
        </div>
        <div id="transactions-list" class="transaction-list"></div>
        <p id="transactions-empty" class="card-list__empty">Cargando transacciones...</p>
        <nav class="pagination" id="transactions-pagination" hidden>
            <button type="button" id="transactions-prev">Anterior</button>
            <span id="transactions-page-indicator" class="current">1 / 1</span>
            <button type="button" id="transactions-next">Siguiente</button>
        </nav>
    </div>

</div>
</body>
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', () => {
    const customerId = /*[[${customer.id}]]*/ 0;
    let ascending = /*[[${ascending}]]*/ false;
    const pageSize = /*[[${transactionsPage.size}]]*/ 10;

    const list = document.getElementById('transactions-list');
    const emptyMessage = document.getElementById('transactions-empty');
    const pagination = document.getElementById('transactions-pagination');
    const prevBtn = document.getElementById('transactions-prev');
    const nextBtn = document.getElementById('transactions-next');
    const pageIndicator = document.getElementById('transactions-page-indicator');
    const sortButton = document.getElementById('transactions-sort');
    const sortLabel = document.getElementById('transactions-sort-label');

    let currentPage = 0;
    let totalPages = 0;
    let currentQueryController = null;

    const clearList = () => {
        list.innerHTML = '';
    };

    const showEmpty = (message) => {
        emptyMessage.textContent = message;
        emptyMessage.hidden = false;
    };

    const hideEmpty = () => {
        emptyMessage.hidden = true;
    };

    const updatePagination = (page, total, hasPrevious, hasNext) => {
        pageIndicator.textContent = `${total === 0 ? 0 : page + 1} / ${total}`;
        prevBtn.disabled = !hasPrevious || total <= 1;
        nextBtn.disabled = !hasNext || total <= 1;
        pagination.hidden = total <= 1;
    };

    const createTransactionCard = (transaction) => {
        const card = document.createElement('div');
        card.className = 'transaction-card';

        const topRow = document.createElement('div');
        topRow.className = 'transaction-card__row';

        const date = document.createElement('span');
        date.className = 'transaction-card__date';
        date.textContent = transaction.formattedDate;
        topRow.appendChild(date);

        const type = document.createElement('span');
        type.className = 'transaction-card__type';
        type.textContent = transaction.type;
        topRow.appendChild(type);

        card.appendChild(topRow);

        const detail = document.createElement('p');
        detail.className = 'transaction-card__detail';
        detail.textContent = transaction.detail;
        card.appendChild(detail);

        const amounts = document.createElement('div');
        amounts.className = 'transaction-card__amounts';

        const amount = document.createElement('span');
        amount.textContent = transaction.formattedAmount;
        amounts.appendChild(amount);

        const balance = document.createElement('span');
        balance.textContent = `Saldo: ${transaction.formattedBalance}`;
        amounts.appendChild(balance);

        card.appendChild(amounts);

        const deleteForm = document.createElement('form');
        deleteForm.method = 'post';
        deleteForm.action = `/customers/transactions/${transaction.id}/delete`;
        deleteForm.onsubmit = () => confirm('驴Seguro que deseas eliminar esta transacci贸n?');

        const customerField = document.createElement('input');
        customerField.type = 'hidden';
        customerField.name = 'customerId';
        customerField.value = customerId;
        deleteForm.appendChild(customerField);

        const deleteButton = document.createElement('button');
        deleteButton.type = 'submit';
        deleteButton.className = 'btn-danger';
        deleteButton.textContent = '';
        deleteButton.title = 'Eliminar transacci贸n';
        deleteForm.appendChild(deleteButton);

        card.appendChild(deleteForm);

        return card;
    };

    const applyResponse = (response) => {
        currentPage = response.page;
        totalPages = response.totalPages;
        clearList();

        if (!response.content.length) {
            showEmpty('Sin transacciones');
        } else {
            hideEmpty();
            response.content.forEach((transaction) => {
                list.appendChild(createTransactionCard(transaction));
            });
        }
        updatePagination(response.page, response.totalPages, response.hasPrevious, response.hasNext);
    };

    const fetchTransactions = (pageToLoad = 0) => {
        if (currentQueryController) {
            currentQueryController.abort();
        }
        currentQueryController = new AbortController();
        fetch(`/customers/${customerId}/transactions?page=${pageToLoad}&size=${pageSize}&ascending=${ascending}`, {
            headers: {'Accept': 'application/json'},
            signal: currentQueryController.signal
        })
            .then((response) => response.ok ? response.json() : Promise.reject())
            .then(applyResponse)
            .catch((error) => {
                if (error.name !== 'AbortError') {
                    showEmpty('Error al cargar transacciones');
                    pagination.hidden = true;
                }
            });
    };

    prevBtn.addEventListener('click', () => {
        if (prevBtn.disabled) {
            return;
        }
        fetchTransactions(Math.max(currentPage - 1, 0));
    });

    nextBtn.addEventListener('click', () => {
        if (nextBtn.disabled) {
            return;
        }
        fetchTransactions(currentPage + 1);
    });

    sortButton.addEventListener('click', () => {
        ascending = !ascending;
        sortLabel.textContent = ascending ? 'Orden: Ascendente' : 'Orden: Descendente';
        fetchTransactions(0);
    });

    fetchTransactions(/*[[${transactionsPage.number}]]*/ 0);
});
/*]]>*/
</script>
</html>
