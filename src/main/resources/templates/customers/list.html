<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Clientes')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container">
    <div th:replace="~{fragments/messages :: messages}"></div>

    <div class="card">
        <div id="search-form">
            <input type="search" id="query" name="q" th:value="${query}" placeholder="Buscar por nombre, direcci√≥n o sector" autofocus autocomplete="off">
        </div>
    </div>

    <div class="card" id="results-card" aria-live="polite" th:classappend="${!showResults} ? ' hidden'">
        <h3 id="results-count" th:text="${customersPage.totalElements} + ' usuarios'">0 usuarios</h3>
        <div class="card-list" id="results-list">
            <a class="customer-card"
               th:each="customer : ${customersPage.content}"
               th:with="formattedDebt=${T(cl.casero.migration.util.CurrencyUtil).format(customer.debt)}"
               th:href="@{'/customers/' + ${customer.id}}"
               th:data-customer-id="${customer.id}"
               th:data-customer-name="${customer.name}"
               th:data-customer-debt="${formattedDebt}"
               th:data-customer-debt-raw="${customer.debt}">
                <span class="customer-card__name" th:text="${customer.name}">Nombre</span>
                <span th:class="|customer-card__debt ${customer.debt > 0 ? 'customer-card__debt--blue' : 'customer-card__debt--red'}|"
                      th:text="${formattedDebt}">$0</span>
            </a>
        </div>
        <p class="card-list__empty"
           id="results-empty"
           th:text="${showResults} ? 'Sin resultados' : 'Escribe para ver clientes'"
           th:attr="hidden=${!customersPage.empty}">
            Sin resultados
        </p>
        <nav class="pagination"
             id="results-pagination"
             th:attr="hidden=${customersPage.totalPages <= 1}">
            <button type="button" id="results-prev" th:disabled="${!customersPage.hasPrevious()}">Anterior</button>
            <span class="current"
                  id="results-page-indicator"
                  th:text="${customersPage.totalPages == 0 ? '0 / 0' : customersPage.number + 1 + ' / ' + customersPage.totalPages}">
                1 / 1
            </span>
            <button type="button" id="results-next" th:disabled="${!customersPage.hasNext()}">Siguiente</button>
        </nav>
    </div>

    <div id="customer-actions" class="customer-actions" hidden>
        <div class="customer-actions__backdrop" id="customer-actions-backdrop" aria-hidden="true"></div>
        <div class="customer-actions__dialog" role="dialog" aria-modal="true">
            <p class="customer-actions__subtitle" id="customer-actions-subtitle">Selecciona una acci√≥n</p>
            <div class="customer-actions__grid" id="customer-actions-list"></div>
        </div>
    </div>

</div>
</body>
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('query');
    const resultsCard = document.getElementById('results-card');
    const resultsCount = document.getElementById('results-count');
    const resultsList = document.getElementById('results-list');
    const resultsEmpty = document.getElementById('results-empty');
    const pagination = document.getElementById('results-pagination');
    const prevButton = document.getElementById('results-prev');
    const nextButton = document.getElementById('results-next');
    const pageIndicator = document.getElementById('results-page-indicator');
    const searchUrl = /*[[@{/customers}]]*/ '/customers';
    const customerDetailBase = /*[[@{/customers/}]]*/ '/customers/';
    const actionsOverlay = document.getElementById('customer-actions');
    const actionsBackdrop = document.getElementById('customer-actions-backdrop');
    const actionsList = document.getElementById('customer-actions-list');
    const actionsSubtitle = document.getElementById('customer-actions-subtitle');

    let debounceId;
    let currentController;
    const pageSize = /*[[${customersPage.size}]]*/ 10;
    let currentPage = /*[[${customersPage.number}]]*/ 0;
    let totalPages = /*[[${customersPage.totalPages}]]*/ 0;
    let totalElements = /*[[${customersPage.totalElements}]]*/ 0;
    let currentQuery = input.value.trim();

    const updateCount = (count) => {
        resultsCount.textContent = `${count} usuarios`;
    };

    const showEmpty = (message) => {
        resultsEmpty.textContent = message;
        resultsEmpty.hidden = false;
    };

    const hideEmpty = () => {
        resultsEmpty.hidden = true;
    };

    const actionDefinitions = actionsOverlay ? [
        {
            key: 'payment',
            label: 'Abonar',
            description: 'Registrar un pago',
            icon: 'üí∏',
            href: (id) => `${customerDetailBase}${id}/actions/payment`
        },
        {
            key: 'sale',
            label: 'Mantenci√≥n',
            description: 'Registrar venta o mantenci√≥n',
            icon: 'üßæ',
            href: (id) => `${customerDetailBase}${id}/actions/sale`
        },
        {
            key: 'refund',
            label: 'Devoluci√≥n',
            description: 'Registrar un reembolso',
            icon: '‚Ü©Ô∏è',
            href: (id) => `${customerDetailBase}${id}/actions/refund`
        },
        {
            key: 'fault-discount',
            label: 'Descuento por falla',
            description: 'Aplicar rebaja por falla o da√±o',
            icon: 'üõ†Ô∏è',
            href: (id) => `${customerDetailBase}${id}/actions/fault-discount`
        },
        {
            key: 'forgiveness',
            label: 'Condonar deuda',
            description: 'Dejar saldo en cero',
            icon: '‚ù§Ô∏è',
            href: (id) => `${customerDetailBase}${id}/actions/forgiveness`
        },
        {
            key: 'transactions',
            label: 'Ver transacciones',
            description: 'Abrir el detalle del cliente',
            icon: 'üìã',
            href: (id) => `${customerDetailBase}${id}`
        }
    ] : [];

    const hideActionsMenu = () => {
        if (!actionsOverlay || actionsOverlay.hidden) {
            return;
        }
        actionsOverlay.hidden = true;
        document.body.classList.remove('modal-open');
    };

    const showActionsMenu = (customer) => {
        if (!actionsOverlay) {
            return;
        }
        const hasDebt = customer.debtValue && Number(customer.debtValue) > 0;
        actionsSubtitle.textContent = '';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = customer.name;
        actionsSubtitle.appendChild(nameSpan);
        if (customer.formattedDebt) {
            const debtSpan = document.createElement('span');
            debtSpan.className = `customer-actions__debt ${hasDebt ? 'customer-actions__debt--blue' : 'customer-actions__debt--red'}`;
            debtSpan.textContent = ` (${customer.formattedDebt})`;
            actionsSubtitle.appendChild(debtSpan);
        }
        actionsList.innerHTML = '';
        actionDefinitions.forEach((action) => {
            const link = document.createElement('a');
            link.className = `customer-actions__action customer-actions__action--${action.key}`;
            link.href = action.href(customer.id);

            const icon = document.createElement('span');
            icon.className = 'customer-actions__icon';
            icon.textContent = action.icon;
            link.appendChild(icon);

            const text = document.createElement('span');
            text.className = 'customer-actions__action-text';
            const title = document.createElement('span');
            title.className = 'customer-actions__action-title';
            title.textContent = action.label;
            const desc = document.createElement('span');
            desc.className = 'customer-actions__action-desc';
            desc.textContent = action.description;
            text.appendChild(title);
            text.appendChild(desc);
            link.appendChild(text);

            actionsList.appendChild(link);
        });
        actionsOverlay.hidden = false;
        document.body.classList.add('modal-open');
    };

    if (actionsOverlay) {
        if (actionsBackdrop) {
            actionsBackdrop.addEventListener('click', hideActionsMenu);
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                hideActionsMenu();
            }
        });
    }

    const attachActionsHandler = (element) => {
        if (!actionsOverlay || element.dataset.actionHandler === 'true') {
            return;
        }
        const customerId = element.dataset.customerId;
        if (!customerId) {
            return;
        }
        const nameElement = element.querySelector('.customer-card__name');
        const debtElement = element.querySelector('.customer-card__debt');
        const debtRaw = element.dataset.customerDebtRaw;
        const customer = {
            id: customerId,
            name: element.dataset.customerName || (nameElement ? nameElement.textContent.trim() : ''),
            formattedDebt: debtElement ? debtElement.textContent.trim() : (element.dataset.customerDebt || ''),
            debtValue: debtRaw !== undefined ? Number(debtRaw) : (debtElement ? Number(debtElement.textContent.replace(/[^0-9.-]/g, '')) : 0)
        };

        element.addEventListener('click', (event) => {
            event.preventDefault();
            showActionsMenu(customer);
        });
        element.addEventListener('contextmenu', (event) => {
            event.preventDefault();
            showActionsMenu(customer);
        });
        element.dataset.actionHandler = 'true';
    };

    const enhanceExistingCards = () => {
        document.querySelectorAll('.customer-card').forEach((card) => attachActionsHandler(card));
    };

    const buildCard = (customer) => {
        const link = document.createElement('a');
        link.className = 'customer-card';
        link.href = `${customerDetailBase}${customer.id}`;
        link.dataset.customerId = customer.id;
        link.dataset.customerName = customer.name;
        if (customer.formattedDebt) {
            link.dataset.customerDebt = customer.formattedDebt;
        }
        if (typeof customer.debtValue === 'number') {
            link.dataset.customerDebtRaw = customer.debtValue;
        }

        const name = document.createElement('span');
        name.className = 'customer-card__name';
        name.textContent = customer.name;
        link.appendChild(name);

        const debt = document.createElement('span');
        debt.className = 'customer-card__debt';
        if (customer.debtValue && Number(customer.debtValue) > 0) {
            debt.classList.add('customer-card__debt--blue');
        } else {
            debt.classList.add('customer-card__debt--red');
        }
        debt.textContent = customer.formattedDebt;
        link.appendChild(debt);

        attachActionsHandler(link);

        return link;
    };

    const renderList = (customers) => {
        resultsList.innerHTML = '';
        if (!customers.length) {
            showEmpty('Sin resultados');
            return;
        }
        hideEmpty();
        resultsCard.classList.remove('hidden');
        customers.forEach((customer) => resultsList.appendChild(buildCard(customer)));
    };

    const updatePagination = (page, total, hasPrevious, hasNext) => {
        if (!total || total <= 1) {
            pagination.hidden = true;
            return;
        }
        pagination.hidden = false;
        pageIndicator.textContent = `${page + 1} / ${total}`;
        prevButton.disabled = !hasPrevious;
        nextButton.disabled = !hasNext;
    };

    const applyResponse = (response) => {
        currentPage = response.page;
        totalPages = response.totalPages;
        totalElements = response.totalElements;
        updateCount(totalElements);
        renderList(response.content);
        updatePagination(response.page, response.totalPages, response.hasPrevious, response.hasNext);
    };

    const handleError = () => {
        updateCount(0);
        resultsList.innerHTML = '';
        showEmpty('Sin resultados');
        pagination.hidden = true;
        resultsCard.classList.remove('hidden');
    };

    const requestPage = (query, pageToLoad) => {
        if (currentController) {
            currentController.abort();
        }
        const controller = new AbortController();
        currentController = controller;
        fetch(`${searchUrl}?q=${encodeURIComponent(query)}&page=${pageToLoad}&size=${pageSize}`, {
            headers: {'Accept': 'application/json'},
            signal: controller.signal
        })
            .then((response) => response.ok ? response.json() : Promise.reject())
            .then(applyResponse)
            .catch((error) => {
                if (error.name !== 'AbortError') {
                    handleError();
                }
            })
            .finally(() => {
                if (currentController === controller) {
                    currentController = null;
                }
            });
    };

    const resetView = () => {
        if (currentController) {
            currentController.abort();
            currentController = null;
        }
        currentQuery = '';
        currentPage = 0;
        totalPages = 0;
        totalElements = 0;
        resultsList.innerHTML = '';
        updateCount(0);
        showEmpty('Escribe para ver clientes');
        pagination.hidden = true;
        resultsCard.classList.add('hidden');
    };

    input.addEventListener('input', () => {
        const query = input.value.trim();
        if (debounceId) {
            clearTimeout(debounceId);
        }
        if (!query) {
            resetView();
            return;
        }
        debounceId = setTimeout(() => {
            currentQuery = query;
            requestPage(query, 0);
        }, 250);
    });

    prevButton.addEventListener('click', () => {
        if (prevButton.disabled || !currentQuery) {
            return;
        }
        requestPage(currentQuery, Math.max(currentPage - 1, 0));
    });

    nextButton.addEventListener('click', () => {
        if (nextButton.disabled || !currentQuery) {
            return;
        }
        requestPage(currentQuery, currentPage + 1);
    });

    if (!currentQuery) {
        resetView();
    } else if (!resultsList.children.length) {
        showEmpty('Sin resultados');
        resultsCard.classList.remove('hidden');
    } else {
        hideEmpty();
        resultsCard.classList.remove('hidden');
    }

    enhanceExistingCards();
});
/*]]>*/
</script>
</html>
