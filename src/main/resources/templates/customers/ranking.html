<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Ranking de clientes')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container">
    <div th:replace="~{fragments/messages :: messages}"></div>
    <div class="card">
        <div class="ranking-header">
            <div>
                <h2>Ranking de clientes</h2>
                <p class="text-muted">Ordenados del mejor al peor score</p>
            </div>
        </div>
        <div class="ranking-explanation">
            <p>
                La nota final es el promedio simple de todos los ciclos de compra del cliente.
                Cada ciclo recibe su propia evaluación considerando constancia de abonos, meses cubiertos y si quedó con saldo pendiente.
                Mientras más ciclos consistentes mantenga, mejor se posiciona en este ranking.
            </p>
        </div>
        <nav class="pagination pagination--top"
             th:attr="hidden=${rankingPage.totalPages <= 1}">
            <span th:if="${!rankingPage.hasPrevious()}" class="disabled">Anterior</span>
            <a th:if="${rankingPage.hasPrevious()}"
               th:href="@{|/customers/ranking?page=${rankingPage.number - 1}&size=${rankingPage.size}&direction=${direction}${range != null ? '&range=' + range : ''}|}">Anterior</a>
            <span class="current"
                  th:text="${rankingPage.totalPages == 0 ? '0 / 0' : rankingPage.number + 1 + ' / ' + rankingPage.totalPages}">1 / 1</span>
            <span th:if="${!rankingPage.hasNext()}" class="disabled">Siguiente</span>
            <a th:if="${rankingPage.hasNext()}"
               th:href="@{|/customers/ranking?page=${rankingPage.number + 1}&size=${rankingPage.size}&direction=${direction}${range != null ? '&range=' + range : ''}|}">Siguiente</a>
        </nav>
        <div class="table-wrapper">
            <table class="ranking-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>
                        <a class="ranking-sort-link"
                           th:href="@{|/customers/ranking?page=0&size=${rankingPage.size}&direction=${nextDirection}${range != null ? '&range=' + range : ''}|}">
                            Cliente
                            <span class="ranking-sort-indicator"
                                  th:text="${direction == 'asc'} ? '⬆️' : '⬇️'">⬇️</span>
                        </a>
                    </th>
                    <th>Ciclos</th>
                    <th>Nota</th>
                </tr>
                </thead>
                <tbody>
                <th:block th:each="entry, iterStat : ${rankingPage.content}">
                <tr>
                    <td th:text="${rankingPage.number * rankingPage.size + iterStat.index + 1}">1</td>
                    <td>
                        <a class="ranking-name-link"
                           th:href="@{'/customers/' + ${entry.id}}"
                           th:text="${entry.name}">Cliente</a>
                    </td>
                    <td th:text="${entry.cycleCount}">0</td>
                    <td class="ranking-score-cell">
                        <button type="button"
                                class="customer-score-chip customer-score-chip--button"
                                th:classappend="${entry.score != null ? ' score-chip--' + T(cl.casero.migration.util.CustomerScoreColor).bucket(entry.score) : ''}"
                                th:attr="data-score-target=${'ranking-expl-' + entry.id}"
                                aria-expanded="false">
                            <strong th:text="${entry.score != null ? #numbers.formatDecimal(entry.score, 1, 'DEFAULT', 2, 'DEFAULT') : '--'}"
                                    th:classappend="${entry.score != null ? ' score-value--' + T(cl.casero.migration.util.CustomerScoreColor).bucket(entry.score) : ''}">7.00</strong>
                        </button>
                    </td>
                </tr>
                <tr class="ranking-explanation-row"
                    th:attr="id=${'ranking-expl-' + entry.id}"
                    hidden>
                    <td colspan="4">
                        <p th:text="${entry.explanation != null ? entry.explanation : 'Sin explicación disponible.'}">
                            Explicación.
                        </p>
                    </td>
                </tr>
                </th:block>
                <tr th:if="${rankingPage.empty}">
                    <td colspan="4" class="ranking-empty">No hay clientes disponibles</td>
                </tr>
                </tbody>
            </table>
        </div>
        <nav class="pagination"
             th:attr="hidden=${rankingPage.totalPages <= 1}">
            <span th:if="${!rankingPage.hasPrevious()}" class="disabled">Anterior</span>
            <a th:if="${rankingPage.hasPrevious()}"
               th:href="@{|/customers/ranking?page=${rankingPage.number - 1}&size=${rankingPage.size}&direction=${direction}${range != null ? '&range=' + range : ''}|}">Anterior</a>
            <span class="current"
                  th:text="${rankingPage.totalPages == 0 ? '0 / 0' : rankingPage.number + 1 + ' / ' + rankingPage.totalPages}">1 / 1</span>
            <span th:if="${!rankingPage.hasNext()}" class="disabled">Siguiente</span>
            <a th:if="${rankingPage.hasNext()}"
               th:href="@{|/customers/ranking?page=${rankingPage.number + 1}&size=${rankingPage.size}&direction=${direction}${range != null ? '&range=' + range : ''}|}">Siguiente</a>
        </nav>
    </div>
</div>
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-score-target]').forEach((button) => {
        const targetId = button.getAttribute('data-score-target');
        const target = targetId ? document.getElementById(targetId) : null;
        if (!target) {
            return;
        }
        button.addEventListener('click', () => {
            const isHidden = target.hasAttribute('hidden');
            if (isHidden) {
                target.removeAttribute('hidden');
                button.setAttribute('aria-expanded', 'true');
            } else {
                target.setAttribute('hidden', '');
                button.setAttribute('aria-expanded', 'false');
            }
        });
    });
});
/*]]>*/
</script>
</body>
</html>
