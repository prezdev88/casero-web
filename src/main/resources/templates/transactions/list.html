<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Transacciones')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container">
    <div class="card"
         th:with="typeIcons=${T(java.util.Map).of(
                 T(cl.casero.migration.domain.enums.TransactionType).SALE, 'ðŸ›’',
                 T(cl.casero.migration.domain.enums.TransactionType).PAYMENT, 'ðŸ’°',
                 T(cl.casero.migration.domain.enums.TransactionType).REFUND, 'â†©ï¸',
                 T(cl.casero.migration.domain.enums.TransactionType).DEBT_FORGIVENESS, 'â¤ï¸',
                 T(cl.casero.migration.domain.enums.TransactionType).INITIAL_BALANCE, 'âš–ï¸',
                 T(cl.casero.migration.domain.enums.TransactionType).FAULT_DISCOUNT, 'ðŸ› ï¸'
         )},
         typeLabels=${T(java.util.Map).of(
                 T(cl.casero.migration.domain.enums.TransactionType).SALE, 'Venta',
                 T(cl.casero.migration.domain.enums.TransactionType).PAYMENT, 'Abono',
                 T(cl.casero.migration.domain.enums.TransactionType).REFUND, 'DevoluciÃ³n',
                 T(cl.casero.migration.domain.enums.TransactionType).DEBT_FORGIVENESS, 'CondonaciÃ³n de deuda',
                 T(cl.casero.migration.domain.enums.TransactionType).INITIAL_BALANCE, 'Saldo inicial',
                 T(cl.casero.migration.domain.enums.TransactionType).FAULT_DISCOUNT, 'Descuento por falla'
         )}">
        <h2>Transacciones</h2>
        <form method="get" class="transaction-filter">
            <label for="type">Tipo</label>
            <select id="type" name="type">
                <option value="" th:selected="${selectedType == null}">Todos</option>
                <option th:each="type : ${types}"
                        th:value="${type.name()}"
                        th:selected="${type == selectedType}"
                        th:text="${typeIcons.getOrDefault(type, 'ðŸ“„') + ' ' + typeLabels.getOrDefault(type, type.name())}">Tipo</option>
            </select>
            <button type="submit">Filtrar</button>
        </form>
        <div class="table-wrapper" th:if="${!transactionsPage.empty}">
            <table>
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Detalle</th>
                    <th>Monto</th>
                    <th>Saldo</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="tx : ${transactionsPage.content}">
                    <td th:text="${dateTimeUtil.format(tx.createdAt)}">01-ene-2024 10:30</td>
                    <td>
                        <a th:href="@{'/customers/' + ${tx.customer.id}}"
                           th:text="${tx.customer.name}">Cliente</a>
                    </td>
                    <td>
                        <span class="transaction-type-cell">
                            <span class="transaction-type-cell__icon"
                                  th:text="${typeIcons.getOrDefault(tx.type, 'ðŸ“„')}">ðŸ›’</span>
                            <span th:text="${typeLabels.getOrDefault(tx.type, tx.type.name())}">Tipo</span>
                        </span>
                    </td>
                    <td th:text="${tx.detail}">Detalle</td>
                    <td th:text="${currencyUtil.format(tx.amount)}">$0</td>
                    <td th:text="${currencyUtil.format(tx.balance)}">$0</td>
                </tr>
                </tbody>
            </table>
        </div>
        <p th:if="${transactionsPage.empty}">No hay transacciones registradas.</p>
        <nav class="pagination"
             th:if="${transactionsPage.totalPages > 1}"
             th:with="prev=${T(java.lang.Math).max(0, transactionsPage.number - 1)},
                      next=${T(java.lang.Math).min(transactionsPage.totalPages - 1, transactionsPage.number + 1)}">
            <a th:href="@{/transactions(page=${prev}, size=${transactionsPage.size}, type=${selectedType})}"
               th:classappend="${!transactionsPage.hasPrevious()} ? ' disabled'">
                Anterior
            </a>
            <span class="current"
                  th:text="${transactionsPage.number + 1} + ' / ' + ${transactionsPage.totalPages}">1 / 1</span>
            <a th:href="@{/transactions(page=${next}, size=${transactionsPage.size}, type=${selectedType})}"
               th:classappend="${!transactionsPage.hasNext()} ? ' disabled'">
                Siguiente
            </a>
        </nav>
        <section class="transaction-chart">
            <div class="transaction-chart__header">
                <h3>EvoluciÃ³n mensual</h3>
                <form id="transactions-chart-form" class="transaction-chart__filters">
                    <div class="transaction-chart__range">
                        <label class="transaction-chart__field">
                            <span>Desde</span>
                            <input type="date" id="chart-start" required>
                        </label>
                        <label class="transaction-chart__field">
                            <span>Hasta</span>
                            <input type="date" id="chart-end" required>
                        </label>
                    </div>
                    <button type="submit">Actualizar</button>
                </form>
            </div>
            <div class="transaction-chart__grid">
                <div class="transaction-chart__panel" id="chart-sales-panel">
                    <h4>Ventas por mes</h4>
                    <div class="transaction-chart__canvas">
                        <canvas id="transactions-chart-sales" height="220"></canvas>
                        <p id="transactions-chart-sales-empty" class="transaction-chart__empty" hidden>
                            No hay datos para el rango seleccionado.
                        </p>
                    </div>
                </div>
                <div class="transaction-chart__panel" id="chart-amounts-panel">
                    <h4>Monto total vs abonos</h4>
                    <div class="transaction-chart__canvas">
                        <canvas id="transactions-chart-amounts" height="220"></canvas>
                        <p id="transactions-chart-amounts-empty" class="transaction-chart__empty" hidden>
                            No hay datos para el rango seleccionado.
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', () => {
    const statsUrl = /*[[@{/transactions/monthly-stats}]]*/ '/transactions/monthly-stats';
    const form = document.getElementById('transactions-chart-form');
    const startInput = document.getElementById('chart-start');
    const endInput = document.getElementById('chart-end');
    const countsPanel = document.getElementById('chart-sales-panel');
    const amountsPanel = document.getElementById('chart-amounts-panel');
    const countsEmpty = document.getElementById('transactions-chart-sales-empty');
    const amountsEmpty = document.getElementById('transactions-chart-amounts-empty');
    const defaultCountsMessage = countsEmpty.textContent.trim();
    const defaultAmountsMessage = amountsEmpty.textContent.trim();
    const countsCtx = document.getElementById('transactions-chart-sales').getContext('2d');
    const amountsCtx = document.getElementById('transactions-chart-amounts').getContext('2d');
    const monthFormatter = new Intl.DateTimeFormat('es-CL', { month: 'short', year: 'numeric' });

    const countsChart = new Chart(countsCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Ventas',
                data: [],
                backgroundColor: 'rgba(26, 115, 232, 0.7)',
                borderColor: '#1a73e8',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => new Intl.NumberFormat('es-CL').format(value)
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Ventas por mes (CLP)',
                    color: '#1f2a37',
                    font: { size: 16, weight: '600' }
                }
            }
        }
    });

    const amountsChart = new Chart(amountsCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Total vendido',
                    data: [],
                    backgroundColor: '#43a047'
                },
                {
                    label: 'Abonos',
                    data: [],
                    backgroundColor: '#1a73e8'
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => new Intl.NumberFormat('es-CL').format(value)
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Montos totales vs abonos (CLP)',
                    color: '#1f2a37',
                    font: { size: 16, weight: '600' }
                }
            }
        }
    });

    const toISOString = (date) => date.toISOString().split('T')[0];

    const setDefaultDates = () => {
        const today = new Date();
        const start = new Date(today);
        start.setDate(1);
        start.setMonth(start.getMonth() - 5);
        endInput.value = toISOString(today);
        startInput.value = toISOString(start);
    };

    const togglePanelState = (panel, messageElement, isEmpty, message) => {
        messageElement.hidden = !isEmpty;
        panel.classList.toggle('is-empty', isEmpty);
        if (message) {
            messageElement.textContent = message;
        }
    };

    const updateCharts = (data) => {
        if (!data.length) {
            togglePanelState(countsPanel, countsEmpty, true, defaultCountsMessage);
            togglePanelState(amountsPanel, amountsEmpty, true, defaultAmountsMessage);
            countsChart.data.labels = [];
            countsChart.data.datasets[0].data = [];
            amountsChart.data.labels = [];
            amountsChart.data.datasets.forEach((dataset) => dataset.data = []);
            countsChart.update();
            amountsChart.update();
        } else {
            const labels = data.map((item) => monthFormatter.format(new Date(`${item.month}T00:00:00`)));
            countsChart.data.labels = labels;
            countsChart.data.datasets[0].data = data.map((item) => item.salesAmount);
            countsChart.update();

            amountsChart.data.labels = labels;
            amountsChart.data.datasets[0].data = data.map((item) => item.salesAmount);
            amountsChart.data.datasets[1].data = data.map((item) => item.paymentsAmount);
            amountsChart.update();

            togglePanelState(countsPanel, countsEmpty, false);
            togglePanelState(amountsPanel, amountsEmpty, false);
        }
    };

    const fetchStats = () => {
        const params = new URLSearchParams({
            startDate: startInput.value,
            endDate: endInput.value
        });
        fetch(`${statsUrl}?${params.toString()}`)
            .then((response) => response.ok ? response.json() : Promise.reject())
            .then(updateCharts)
            .catch(() => {
                togglePanelState(countsPanel, countsEmpty, true, 'No se pudo cargar el grÃ¡fico.');
                togglePanelState(amountsPanel, amountsEmpty, true, 'No se pudo cargar el grÃ¡fico.');
            });
    };

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        fetchStats();
    });

    setDefaultDates();
    fetchStats();
});
</script>
</body>
</html>
